## 单细胞平台结果页面编写规范

### 页面结构模板

```jsx
import { useEffect, useRef, useState } from 'react';
import PageTemplate from '../../components/PageTemplate/index.jsx';
import ResultPageTemplate from '../../components/ResultPageTemplate/index.jsx';
import { message, Tabs } from 'antd';
import * as d3 from 'd3';

const YourPageName = () => {
  // 1. 状态管理
  const [activeTab, setActiveTab] = useState('tab1'); // Tab 切换状态
  const chart1Ref = useRef(null); // 图表1的 DOM 引用
  const chart2Ref = useRef(null); // 图表2的 DOM 引用
  
  // 2. 表格选中状态（每个 Tab 独立）
  const [selectedTab1Rows, setSelectedTab1Rows] = useState(['1', '2', '3']); // 默认全选
  const [selectedTab2Rows, setSelectedTab2Rows] = useState(['1', '2', '3']);

  // 3. 表格数据定义
  const tab1TableData = [
    { key: '1', field1: 'value1', field2: 100, field3: '10%' },
    { key: '2', field1: 'value2', field2: 200, field3: '20%' },
    // ... 更多数据
  ];

  const tab1TableColumns = [
    { title: '列名1', dataIndex: 'field1', key: 'field1' },
    { title: '列名2', dataIndex: 'field2', key: 'field2', sorter: (a, b) => a.field2 - b.field2 },
    { title: '列名3', dataIndex: 'field3', key: 'field3' },
  ];

  // 4. 图表更新函数（使用 D3.js）
  const updateChart1 = (selectedKeys) => {
    if (!chart1Ref.current) return;
  
    // 清空之前的内容
    d3.select(chart1Ref.current).selectAll('*').remove();
  
    // 过滤选中的数据
    const selectedData = tab1TableData.filter(item => selectedKeys.includes(item.key));
    if (selectedData.length === 0) return;
  
    // 设置尺寸和边距
    const margin = { top: 60, right: 120, bottom: 50, left: 60 };
    const width = chart1Ref.current.clientWidth - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;
  
    // 创建 SVG
    const svg = d3.select(chart1Ref.current)
      .append('svg')
      .attr('width', width + margin.left + margin.right)
      .attr('height', height + margin.top + margin.bottom)
      .append('g')
      .attr('transform', `translate(${margin.left},${margin.top})`);
  
    // 绘制图表逻辑...
    // 添加标题、坐标轴、图例等
  };

  // 5. 图表初始化和响应式处理
  useEffect(() => {
    if (activeTab === 'tab1' && chart1Ref.current) {
      updateChart1(selectedTab1Rows);
    
      const handleResize = () => updateChart1(selectedTab1Rows);
      window.addEventListener('resize', handleResize);
    
      return () => {
        window.removeEventListener('resize', handleResize);
      };
    }
  }, [activeTab, selectedTab1Rows]);

  // 6. 下载和刷新处理函数
  const handleTab1Download = (selectedRowKeys) => {
    message.success(`正在下载 Tab1 的 ${selectedRowKeys.length} 条数据`);
  };

  const handleTab1Refresh = () => {
    message.success('已刷新 Tab1 数据');
    setSelectedTab1Rows(['1', '2', '3']); // 重置为全选
  };

  // 7. Tab 配置
  const tabItems = [
    { key: 'tab1', label: 'Tab标签1' },
    { key: 'tab2', label: 'Tab标签2' },
  ];

  // 8. 页面渲染
  return (
    <PageTemplate pageTitle="页面标题">
      <Tabs
        activeKey={activeTab}
        onChange={setActiveTab}
        items={tabItems}
        style={{ marginBottom: 16 }}
      />

      {/* Tab1 内容 */}
      <div style={{ display: activeTab === 'tab1' ? 'block' : 'none' }}>
        <ResultPageTemplate 
          chartContent={
            <div 
              ref={chart1Ref}
              style={{ 
                width: '100%',
                height: '500px',
                background: '#fff',
                borderRadius: 4,
              }}
            />
          }
          tableColumns={tab1TableColumns}
          tableData={tab1TableData}
          selectedRowKeys={selectedTab1Rows}
          onSelectChange={setSelectedTab1Rows}
          onDownload={handleTab1Download}
          onRefresh={handleTab1Refresh}
        />
      </div>

      {/* Tab2 内容 - 同样的结构 */}
    </PageTemplate>
  );
};

export default YourPageName;
```

### 关键要点

1. **状态管理**：每个 Tab 独立管理选中状态
2. **图表引用**：使用 `useRef` 获取 DOM 引用
3. **数据过滤**：根据 `selectedRowKeys` 过滤数据
4. **D3 渲染**：先清空再重绘，确保图表正确更新
5. **响应式**：监听窗口大小变化，重新绘制图表
6. **Tab 切换**：使用 `display: none/block` 而不是条件渲染
7. **默认全选**：初始化时设置所有数据的 key

### 常用 D3 图表类型

- **堆叠柱状图**：`d3.stack()` + `d3.scaleBand()`
- **河流图**：`d3.stack().offset(d3.stackOffsetWiggle)` + `d3.area()`
- **折线图**：`d3.line()` + `d3.scaleLinear()`
- **散点图**：`svg.selectAll('circle')` + `d3.scaleLinear()`
- **热力图**：`svg.selectAll('rect')` + `d3.scaleSequential()`

### 提示词模板

```
请帮我创建一个单细胞平台的结果页面：

页面名称：[页面名称]
Tab 数量：[数量]

每个 Tab 包含：
1. Tab1: [Tab名称]
   - 图表类型：[堆叠柱状图/河流图/折线图/散点图等]
   - 表格列：[列名1, 列名2, 列名3...]
   - 数据示例：[提供几行示例数据]

2. Tab2: [Tab名称]
   - 图表类型：[...]
   - 表格列：[...]
   - 数据示例：[...]

要求：
- 使用 D3.js 绘制图表
- 表格勾选与图表联动
- 默认全选所有数据
- 支持搜索、分页、下载、刷新功能
- Tab 切换时图表正常显示
```

### 注意事项

1. 所有图表使用 D3.js，不使用 ECharts
2. 表格数据必须有 `key` 字段作为唯一标识
3. 图表容器高度固定为 500px
4. 颜色使用统一的配色方案：`['#5470c6', '#91cc75', '#fac858']`
5. 图表标题、坐标轴、图例必须完整
6. 避免使用未定义的变量，通过 ESLint 检查
